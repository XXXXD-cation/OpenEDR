# OpenEDR 系统架构设计文档

## 1. 系统概述

OpenEDR是一个模块化、可扩展的端点检测与响应系统，采用分布式架构设计，支持大规模部署和高性能数据处理。

## 2. 架构原则

- **模块化设计**: 各组件独立开发、部署和升级
- **高可用性**: 支持集群部署和故障转移
- **可扩展性**: 水平扩展能力，支持数万端点
- **安全性**: 端到端加密，最小权限原则
- **实时性**: 低延迟的威胁检测和响应
- **可观测性**: 完整的监控和日志记录

## 3. 核心组件

### 3.1 EDR Agent

#### 3.1.1 数据收集器 (Data Collector)
- **进程监控**: 
  - 进程创建/终止事件
  - 进程树关系
  - 命令行参数
  - 进程注入检测
- **网络监控**:
  - TCP/UDP连接
  - DNS查询
  - HTTP/HTTPS流量元数据
  - 网络流量异常检测
- **文件系统监控**:
  - 文件创建/修改/删除
  - 文件哈希计算
  - 文件权限变更
  - 敏感目录监控
- **注册表监控** (Windows):
  - 关键注册表项变更
  - 启动项监控
  - 服务注册

#### 3.1.2 本地检测引擎 (Local Detection Engine)
- **规则引擎**: YARA规则支持
- **行为分析**: 基于行为模式的异常检测
- **机器学习模型**: 轻量级ML模型本地推理
- **IOC匹配**: 威胁指标快速匹配

#### 3.1.3 响应模块 (Response Module)
- **进程操作**: 终止、挂起进程
- **网络隔离**: 阻断网络连接
- **文件隔离**: 隔离可疑文件
- **系统恢复**: 回滚恶意更改

#### 3.1.4 内核驱动 (Kernel Driver)
- **Linux**: eBPF程序
  - kprobes/kretprobes
  - tracepoints
  - 网络过滤器
- **Windows**: WDF驱动
  - 文件系统微过滤器
  - 网络过滤器
  - 进程/线程回调

### 3.2 中央服务器 (Central Server)

#### 3.2.1 API网关 (API Gateway)
- **RESTful API**: Web控制台接口
- **GraphQL API**: 灵活的数据查询
- **WebSocket**: 实时事件推送
- **认证授权**: JWT + RBAC

#### 3.2.2 Agent管理服务 (Agent Management Service)
- **注册管理**: Agent注册和认证
- **配置下发**: 策略和规则分发
- **健康检查**: Agent状态监控
- **升级管理**: Agent版本控制

#### 3.2.3 数据处理管道 (Data Processing Pipeline)
- **数据接收**: gRPC服务器
- **数据验证**: 格式和完整性检查
- **数据增强**: 威胁情报关联
- **数据路由**: 分发到不同处理器

#### 3.2.4 检测引擎 (Detection Engine)
- **规则引擎**: 
  - Sigma规则支持
  - 自定义规则语言
  - 规则优先级管理
- **关联分析**:
  - 事件关联
  - 时间序列分析
  - 攻击链识别
- **机器学习**:
  - 异常检测模型
  - 威胁分类模型
  - 模型训练管道

#### 3.2.5 响应编排器 (Response Orchestrator)
- **自动响应**: 基于策略的自动化响应
- **工作流引擎**: 复杂响应流程编排
- **通知系统**: 多渠道告警通知
- **集成接口**: SOAR平台集成

### 3.3 数据存储

#### 3.3.1 时序数据库
- **Elasticsearch**: 事件数据存储和搜索
- **数据分片**: 基于时间的索引分片
- **数据保留**: 自动数据过期策略

#### 3.3.2 关系数据库
- **PostgreSQL**: 
  - Agent元数据
  - 用户和权限
  - 配置和策略
  - 告警和事件

#### 3.3.3 缓存层
- **Redis**:
  - Session存储
  - 实时数据缓存
  - 分布式锁
  - 速率限制

#### 3.3.4 对象存储
- **MinIO/S3**:
  - 文件样本存储
  - 日志归档
  - 报告存储

### 3.4 Web控制台

#### 3.4.1 仪表板
- **实时监控**: 系统状态概览
- **威胁态势**: 威胁趋势和统计
- **性能指标**: 系统性能监控

#### 3.4.2 威胁管理
- **告警中心**: 统一告警管理
- **事件调查**: 详细事件分析
- **威胁狩猎**: 主动威胁搜索

#### 3.4.3 配置管理
- **策略编辑器**: 可视化策略配置
- **规则管理**: 检测规则管理
- **Agent管理**: Agent配置和控制

## 4. 数据流设计

### 4.1 事件收集流程
```
Agent → gRPC/TLS → Server → Kafka → 处理器 → Elasticsearch
                                  ↓
                            检测引擎 → 告警 → 响应
```

### 4.2 配置下发流程
```
控制台 → API → 配置服务 → Redis → gRPC推送 → Agent
```

## 5. 通信协议

### 5.1 Agent-Server通信
- **协议**: gRPC over TLS 1.3
- **认证**: 双向TLS + Token
- **压缩**: gzip/snappy
- **心跳**: 30秒间隔

### 5.2 API通信
- **协议**: HTTPS
- **认证**: JWT Bearer Token
- **版本控制**: URL路径版本

## 6. 安全设计

### 6.1 传输安全
- **TLS 1.3**: 所有通信加密
- **证书管理**: 自动证书轮换
- **密钥存储**: HSM/Vault集成

### 6.2 访问控制
- **RBAC**: 基于角色的访问控制
- **MFA**: 多因素认证支持
- **审计日志**: 完整操作审计

### 6.3 数据安全
- **加密存储**: 敏感数据加密
- **数据脱敏**: PII数据自动脱敏
- **备份加密**: 加密备份

## 7. 性能指标

### 7.1 Agent性能
- CPU使用率: < 5%
- 内存占用: < 200MB
- 事件延迟: < 1秒

### 7.2 服务器性能
- 事件处理: 100k events/秒
- API响应: < 100ms (P99)
- 存储效率: 压缩比 > 10:1

## 8. 部署架构

### 8.1 小型部署 (< 1000 endpoints)
- 单服务器部署
- Docker Compose

### 8.2 中型部署 (1000-10000 endpoints)
- 3节点集群
- Kubernetes部署

### 8.3 大型部署 (> 10000 endpoints)
- 多区域部署
- 自动扩缩容
- CDN加速

## 9. 监控和运维

### 9.1 监控指标
- **系统指标**: CPU、内存、磁盘、网络
- **应用指标**: 请求量、错误率、延迟
- **业务指标**: 检测率、误报率、响应时间

### 9.2 日志管理
- **集中日志**: ELK Stack
- **日志级别**: 动态调整
- **日志轮转**: 自动归档

### 9.3 告警机制
- **告警规则**: 基于指标的告警
- **告警路由**: 分级告警
- **告警抑制**: 避免告警风暴

## 10. 扩展性设计

### 10.1 插件系统
- **检测插件**: 自定义检测逻辑
- **响应插件**: 自定义响应动作
- **数据插件**: 自定义数据源

### 10.2 API扩展
- **Webhook**: 事件推送
- **REST API**: 第三方集成
- **SDK**: 多语言SDK支持

## 11. 技术栈详情

### 11.1 开发语言
- **Go**: 服务器端主要语言
- **C/C++**: Agent核心和内核模块
- **Python**: 数据分析和机器学习
- **TypeScript**: Web前端

### 11.2 主要框架和库
- **服务器端**:
  - Gin (Web框架)
  - gRPC-go
  - GORM (ORM)
  - Cobra (CLI)
- **Agent端**:
  - libbpf (Linux eBPF)
  - WDF (Windows驱动)
  - SQLite3
  - protobuf-c
- **前端**:
  - React 18
  - Redux Toolkit
  - Ant Design
  - ECharts

### 11.3 基础设施
- **容器化**: Docker
- **编排**: Kubernetes
- **CI/CD**: GitLab CI / GitHub Actions
- **监控**: Prometheus + Grafana 